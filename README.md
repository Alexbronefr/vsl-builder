# VSL Builder

Полнофункциональный конструктор VSL-прокладок (Video Sales Letter landing pages) с админ-панелью.

## Технологии

- **Framework**: Next.js 14 (App Router)
- **Language**: TypeScript
- **Styling**: Tailwind CSS + shadcn/ui компоненты
- **Backend/DB**: Supabase (Auth, PostgreSQL, Storage, Realtime)
- **Video Storage**: Cloudflare R2 + CDN (HLS-сегменты)
- **Video Player**: HLS.js
- **Charts**: Recharts

## Установка

1. Установите зависимости:
```bash
npm install
```

2. Настройте переменные окружения:
Создайте `.env.local` и заполните значения:
- `NEXT_PUBLIC_SUPABASE_URL` - URL вашего Supabase проекта
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` - Anon key из Supabase
- `SUPABASE_SERVICE_ROLE_KEY` - Service role key из Supabase (для админских операций)
- `CONVERSION_SERVICE_URL` - URL сервиса конвертации (опционально)
- `CONVERSION_WEBHOOK_SECRET` - Секретный ключ для верификации webhook
- `R2_ENDPOINT`, `R2_ACCESS_KEY_ID`, `R2_SECRET_ACCESS_KEY`, `R2_BUCKET_NAME` - Cloudflare R2 (опционально)
- `NEXT_PUBLIC_APP_URL` - URL вашего приложения
- `ALLOWED_DOMAIN` - Разрешённый домен для key server
- `SESSION_TOKEN_SECRET` - Секрет для JWT токенов

3. Создайте базу данных:
Выполните SQL из `supabase/schema.sql` в Supabase SQL Editor

4. Создайте Storage bucket в Supabase:
- Перейдите в Storage в Supabase Dashboard
- Создайте bucket с именем `raw-videos`
- Настройте политики доступа (публичный доступ для чтения не нужен)

5. Запустите проект:
```bash
npm run dev
```

## Структура проекта

- `/app` - Next.js App Router страницы
- `/app/admin` - Админ-панель
- `/app/v/[slug]` - Публичные лендинги
- `/app/api` - API роуты
- `/lib` - Утилиты и хелперы
- `/components` - React компоненты
- `/components/admin` - Компоненты админки
- `/components/lander` - Компоненты лендинга
- `/public` - Статические файлы (lander-init.js)
- `/supabase` - SQL схемы
- `/types` - TypeScript типы

## Роуты

### Админка
- `/admin` - Дашборд
- `/admin/login` - Вход
- `/admin/register` - Регистрация
- `/admin/landers` - Список лендингов
- `/admin/landers/new` - Создание лендинга
- `/admin/landers/[id]/edit` - Редактирование лендинга
- `/admin/landers/[id]/leads` - Заявки лендинга
- `/admin/videos` - Список видео
- `/admin/videos/upload` - Загрузка видео
- `/admin/analytics` - Аналитика
- `/admin/team` - Управление командой
- `/admin/settings` - Настройки (заглушка)

### Публичные
- `/v/[slug]` - Публичный лендинг

### API
- `/api/videos` - CRUD операции с видео
- `/api/videos/upload` - Загрузка видео файла
- `/api/videos/[id]` - Операции с конкретным видео
- `/api/conversion/webhook` - Webhook от сервиса конвертации
- `/api/landers` - CRUD операции с лендингами
- `/api/landers/[id]` - Операции с лендингом
- `/api/leads` - Приём заявок
- `/api/leads/[landerId]` - Получение заявок лендинга
- `/api/analytics` - Приём аналитических событий
- `/api/key/[videoId]` - Отдача AES-128 ключа для HLS
- `/api/team/invite` - Приглашение участника
- `/api/team/members/[id]` - Изменение роли/удаление участника

## Статус разработки

✅ **БЛОК 1**: Инициализация проекта + Supabase + Auth - ЗАВЕРШЁН
- [x] Next.js 14 с App Router
- [x] Supabase клиенты (server/client)
- [x] Middleware для защиты /admin
- [x] Страницы авторизации
- [x] Схема базы данных

✅ **БЛОК 2**: Админка — Дашборд + CRUD лендингов - ЗАВЕРШЁН
- [x] Дашборд с метриками
- [x] Таблица лендингов с фильтрами
- [x] Создание, редактирование, дублирование, удаление
- [x] Изменение статуса

✅ **БЛОК 3**: Админка — Загрузка и конвертация видео - ЗАВЕРШЁН
- [x] Загрузка видео в Supabase Storage
- [x] Интеграция с сервисом конвертации
- [x] Webhook для статуса конвертации
- [x] Отслеживание прогресса

✅ **БЛОК 4**: Админка — Редактор лендинга - ЗАВЕРШЁН
- [x] Полный редактор с табами
- [x] Автосохранение (debounce)
- [x] Все настройки: контент, видео, форма, фишки, стиль, аналитика, настройки

✅ **БЛОК 5**: Админка — Заявки и аналитика - ЗАВЕРШЁН
- [x] Страница заявок с фильтрами и экспортом CSV
- [x] Аналитика с графиками (Recharts)
- [x] Воронка конверсии, устройства, страны, UTM источники

✅ **БЛОК 6**: Лендинг — Core (SSR, конфиг, layout) - ЗАВЕРШЁН
- [x] SSR рендеринг лендинга
- [x] Inline стили из конфига
- [x] Интеграция аналитики (GA, Facebook Pixel)
- [x] Базовая HTML структура

✅ **БЛОК 7**: Лендинг — HLS-плеер с защитой - ЗАВЕРШЁН
- [x] HLS.js плеер с оптимизацией
- [x] Key Server API
- [x] Многоуровневая защита от скачивания
- [x] Кастомные контролы
- [x] Нелинейный прогресс-бар
- [x] Блокировка перемотки вперёд

✅ **БЛОК 8**: Лендинг — Все психологические фишки - ЗАВЕРШЁН
- [x] Social Proof уведомления
- [x] Счётчик зрителей
- [x] Блюр формы
- [x] Пульсирующая CTA
- [x] Exit-intent popup
- [x] Геолокация в тексте
- [x] Countdown таймер
- [x] Sticky video при скролле
- [x] Прогрессивное раскрытие контента
- [x] И другие фишки

✅ **БЛОК 9**: Лендинг — Форма, отправка, редирект - ЗАВЕРШЁН
- [x] API для приёма заявок
- [x] Валидация формы
- [x] UTM tracking
- [x] Геолокация по IP
- [x] Конфетти при отправке
- [x] Показ второго видео
- [x] Редирект или страница благодарности

✅ **БЛОК 10**: Аналитика (клиентская часть) - ЗАВЕРШЁН
- [x] API для приёма аналитических событий
- [x] Батчинг событий
- [x] Отправка при закрытии страницы
- [x] Трекинг всех событий
- [x] Video heartbeat для heatmap

✅ **БЛОК 11**: Админка — Управление командой - ЗАВЕРШЁН
- [x] Страница управления командой
- [x] Приглашение участников по email
- [x] Изменение ролей (admin/editor/viewer)
- [x] Удаление участников
- [x] Защита от удаления последнего admin

## Особенности

- **SSR**: Полный серверный рендеринг для SEO
- **Защита видео**: Многоуровневая защита от скачивания
- **Психологические триггеры**: 20+ фишек для повышения конверсии
- **Аналитика**: Детальная аналитика с графиками
- **Командная работа**: Система ролей и приглашений
- **Производительность**: Оптимизация для медленного интернета

## Примечания

### Сервис конвертации

Сервис конвертации - это отдельный Docker-сервис, который должен быть развёрнут на Railway/Render. Он принимает POST запросы на `/convert` и отправляет webhook обратно в Next.js приложение.

Если сервис конвертации не настроен, видео будут загружаться в Supabase Storage, но конвертация не будет запускаться автоматически.

### Supabase Storage

Не забудьте создать bucket `raw-videos` в Supabase Storage перед загрузкой видео.

### Service Role Key

Для работы некоторых функций (приглашения, получение email пользователей) требуется `SUPABASE_SERVICE_ROLE_KEY`. Без него некоторые функции будут работать в упрощённом режиме.
