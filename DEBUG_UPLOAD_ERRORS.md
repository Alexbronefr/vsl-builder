# Диагностика ошибки "Failed to fetch" при загрузке видео

## Где смотреть логи

### 1. Консоль браузера (самое важное!)

**Как открыть:**
- Chrome/Edge: `F12` или `Ctrl+Shift+I` (Windows) / `Cmd+Option+I` (Mac)
- Firefox: `F12` или `Ctrl+Shift+K` (Windows) / `Cmd+Option+K` (Mac)
- Safari: `Cmd+Option+I` (нужно включить Developer menu в настройках)

**Что искать:**
- Логи с префиксом `[Client]` - показывают процесс загрузки на клиенте
- Ошибки с красным цветом
- Сообщения типа `Failed to fetch`, `NetworkError`, `CORS error`

**Примеры логов:**
```
[Client] Начало загрузки видео: { fileName: "...", fileSize: "..." }
[Client] Шаг 1: Создание записи в БД...
[Client] Запись создана за 123ms
[Client] Шаг 2: Начало прямой загрузки в Supabase Storage...
[Client] ❌ Ошибка загрузки: { error: ..., message: "..." }
```

### 2. Вкладка Network (Network Tab)

**Как открыть:**
- В консоли браузера перейдите на вкладку **Network** (Сеть)
- Обновите страницу или начните загрузку
- Фильтр: `XHR` или `Fetch` для API запросов

**Что проверять:**
1. **Запрос `/api/videos/upload-url`**:
   - Статус: должен быть `200 OK` (зеленый)
   - Если `401` - проблема с авторизацией
   - Если `500` - ошибка на сервере
   - Если `Failed` (красный) - проблема с сетью/CORS

2. **Запросы к Supabase Storage**:
   - Ищите запросы к `*.supabase.co/storage/v1/object/...`
   - Статус: должен быть `200 OK`
   - Если `401/403` - проблема с правами доступа
   - Если `413` - файл слишком большой
   - Если `Failed` - проблема с сетью/CORS

3. **Запрос `/api/videos/upload-complete`**:
   - Статус: должен быть `200 OK`
   - Если ошибка - проверьте детали в Response

**Как проверить:**
- Кликните на запрос → вкладка **Headers** - проверьте заголовки запроса
- Вкладка **Response** - проверьте ответ сервера
- Вкладка **Preview** - удобный просмотр JSON ответа

### 3. Логи сервера (Vercel)

**Где смотреть:**
1. **Vercel Dashboard**:
   - Откройте ваш проект в Vercel
   - Перейдите в **Deployments** → выберите последний деплой
   - Вкладка **Functions** → выберите функцию `/api/videos/upload-url`
   - Вкладка **Logs** - здесь видны все логи сервера

2. **Vercel CLI** (если установлен):
   ```bash
   vercel logs --follow
   ```

**Что искать:**
- Логи с префиксом `[API /upload-url]` - показывают процесс на сервере
- Ошибки с красным цветом
- Сообщения об авторизации, создании записи в БД

**Примеры логов:**
```
[API /upload-url] Запрос получен: { method: "POST", ... }
[API /upload-url] Команда найдена: { teamId: "..." }
[API /upload-url] ✅ Успешно, возвращаем данные: { videoId: "...", filePath: "..." }
```

### 4. Логи Supabase

**Где смотреть:**
- **Supabase Dashboard** → **Logs** → **Postgres Logs** или **API Logs**
- Проверьте ошибки, связанные с Storage или Database

## Типичные причины ошибки "Failed to fetch"

### 1. Проблемы с сетью
**Симптомы:**
- Запросы показывают `Failed` в Network tab
- Нет ответа от сервера

**Решение:**
- Проверьте подключение к интернету
- Проверьте, не блокирует ли файрвол/антивирус запросы
- Попробуйте другой браузер или режим инкогнито

### 2. CORS ошибки
**Симптомы:**
- В консоли: `Access to fetch at '...' from origin '...' has been blocked by CORS policy`
- В Network: запрос показывает `CORS error`

**Решение:**
- Убедитесь, что `NEXT_PUBLIC_SUPABASE_URL` настроен правильно
- Проверьте настройки CORS в Supabase Dashboard → Settings → API

### 3. Проблемы с авторизацией
**Симптомы:**
- Запрос `/api/videos/upload-url` возвращает `401 Unauthorized`
- В логах: `[API /upload-url] Не авторизован, команда не найдена`

**Решение:**
- Выйдите и войдите снова в админ-панель
- Проверьте, что сессия активна (проверьте cookies в Application tab)

### 4. Проблемы с Supabase Storage
**Симптомы:**
- Запрос к Supabase Storage возвращает ошибку
- В консоли: `Ошибка загрузки в Supabase Storage: ...`

**Решение:**
- Проверьте, что bucket `raw-videos` существует в Supabase Dashboard → Storage
- Проверьте Storage Policies (см. `supabase/storage-policies.sql`)
- Убедитесь, что `NEXT_PUBLIC_SUPABASE_ANON_KEY` правильный

### 5. Таймауты при больших файлах
**Симптомы:**
- Загрузка начинается, но прерывается через некоторое время
- В Network: запрос показывает `(failed)` или `(cancelled)`

**Решение:**
- Для больших файлов (>100MB) используется multipart upload автоматически
- Проверьте, что файл не превышает 5GB
- Убедитесь, что есть стабильное интернет-соединение

### 6. Проблемы с переменными окружения
**Симптомы:**
- В консоли: `Supabase клиент не инициализирован`
- В логах: `NEXT_PUBLIC_SUPABASE_URL` или `NEXT_PUBLIC_SUPABASE_ANON_KEY` undefined

**Решение:**
- Проверьте переменные окружения в Vercel Dashboard → Settings → Environment Variables
- Убедитесь, что переменные начинаются с `NEXT_PUBLIC_` для клиентской части
- Перезапустите деплой после изменения переменных

## Пошаговая диагностика

1. **Откройте консоль браузера** (F12)
2. **Начните загрузку видео**
3. **Смотрите логи в консоли** - они покажут, на каком этапе происходит ошибка:
   - `[Client] Шаг 1` - создание записи в БД
   - `[Client] Шаг 2` - загрузка в Supabase Storage
   - `[Client] Шаг 3` - завершение загрузки
4. **Проверьте Network tab** - найдите запрос, который завершился с ошибкой
5. **Проверьте логи сервера в Vercel** - если ошибка на этапе 1 или 3
6. **Проверьте логи Supabase** - если ошибка на этапе 2

## Что делать после диагностики

После того, как вы определили причину ошибки:

1. **Если проблема с сетью/CORS**: проверьте настройки Supabase и Vercel
2. **Если проблема с авторизацией**: перелогиньтесь
3. **Если проблема с Storage**: проверьте bucket и policies
4. **Если проблема с переменными**: обновите их в Vercel и перезапустите деплой

## Полезные команды для проверки

### Проверка переменных окружения в браузере:
```javascript
// В консоли браузера выполните:
console.log('Supabase URL:', process.env.NEXT_PUBLIC_SUPABASE_URL)
console.log('Supabase Key:', process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY ? 'установлен' : 'отсутствует')
```

### Проверка Supabase клиента:
```javascript
// В консоли браузера выполните:
import { createClient } from '@/lib/supabase/client'
const supabase = createClient()
console.log('Supabase client:', supabase)
```

## Контакты для поддержки

Если проблема не решается:
1. Соберите все логи из консоли браузера
2. Сделайте скриншоты Network tab с ошибками
3. Проверьте логи Vercel и Supabase
4. Опишите шаги для воспроизведения ошибки
